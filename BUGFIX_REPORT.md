# Bug ä¿®å¤æŠ¥å‘Š - å¸‚åœºæ‰«æåŠŸèƒ½

**æ—¥æœŸ:** 2026-01-17
**ä¿®å¤äººå‘˜:** Claude Code
**é—®é¢˜ç¼–å·:** #001

---

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨è®¿é—®å¸‚åœºæ‰«æé¡µé¢ (`http://localhost:5001/scanner`) æ—¶ï¼Œé€‰æ‹© "NASDAQ" æŒ‡æ•°å¹¶ç‚¹å‡»"å¼€å§‹æ‰«æ"åï¼Œæ”¶åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
é”™è¯¯: Invalid filter option 'NASDAQ'.
Possible filter options: ['Any', 'S&P 500', 'NASDAQ 100', 'DJIA', 'RUSSELL 2000']
```

![é”™è¯¯æˆªå›¾](ç”¨æˆ·æä¾›çš„æˆªå›¾æ˜¾ç¤ºçº¢è‰²é”™è¯¯æ¡†)

---

## æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜ 1: æŒ‡æ•°åç§°æ˜ å°„é”™è¯¯

**æ–‡ä»¶:** `web/api/routes.py:279`

**åŸå§‹ä»£ç :**
```python
filters_dict = {
    'Index': index.upper() if index != 'sp500' else 'S&P 500',
    ...
}
```

**é—®é¢˜:**
- å‰ç«¯ä¼ é€’ `'nasdaq'` å‚æ•°
- åç«¯ç®€å•åœ°è½¬æ¢ä¸ºå¤§å†™ `'NASDAQ'`
- finvizfinance åº“æœŸæœ›çš„æ˜¯ `'NASDAQ 100'`ï¼ˆåŒ…å«ç©ºæ ¼å’Œæ•°å­—ï¼‰

### é—®é¢˜ 2: PE å‚æ•°æ ¼å¼é”™è¯¯

**åŸå§‹ä»£ç :**
```python
max_pe = float(request.args.get('max_pe', 25))
filters_dict = {'P/E': f'Under {max_pe}', ...}
```

**é—®é¢˜:**
- ç”Ÿæˆçš„å­—ç¬¦ä¸²æ˜¯ `'Under 25.0'`ï¼ˆæµ®ç‚¹æ•°ï¼‰
- finvizfinance æœŸæœ› `'Under 25'`ï¼ˆæ•´æ•°ï¼‰

### é—®é¢˜ 3: PEG å‚æ•°æ ¼å¼é”™è¯¯

åŒæ ·çš„é—®é¢˜ï¼ŒPEG å€¼ä¹Ÿå¿…é¡»æ˜¯æ•´æ•°æ ¼å¼ã€‚

### é—®é¢˜ 4: å‰ç«¯é€‰é¡¹ä¸å®Œæ•´

å‰ç«¯åªæä¾›äº† 3 ä¸ªæŒ‡æ•°é€‰é¡¹ï¼Œç¼ºå°‘ Russell 2000ï¼Œä¸” PEG è¾“å…¥å…è®¸å°æ•°ã€‚

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: æ·»åŠ æŒ‡æ•°åç§°æ˜ å°„è¡¨

**æ–‡ä»¶:** `web/api/routes.py:277-284`

```python
# æ˜ å°„æŒ‡æ•°åç§°åˆ° finviz æ¥å—çš„æ ¼å¼
index_mapping = {
    'sp500': 'S&P 500',
    'nasdaq': 'NASDAQ 100',
    'dow': 'DJIA',
    'russell': 'RUSSELL 2000',
    'any': 'Any'
}

finviz_index = index_mapping.get(index.lower(), 'S&P 500')
```

**æ•ˆæœ:**
- âœ… `'nasdaq'` â†’ `'NASDAQ 100'`
- âœ… `'dow'` â†’ `'DJIA'`
- âœ… æ”¯æŒæ‰€æœ‰ finviz å¯ç”¨æŒ‡æ•°
- âœ… å®¹é”™å¤„ç†ï¼ˆé»˜è®¤ S&P 500ï¼‰

### ä¿®å¤ 2: å‚æ•°ç±»å‹è½¬æ¢

**æ–‡ä»¶:** `web/api/routes.py:270-271`

```python
max_pe = int(float(request.args.get('max_pe', 25)))   # è½¬æ¢ä¸ºæ•´æ•°
max_peg = int(float(request.args.get('max_peg', 1)))  # PEG ä¹Ÿå¿…é¡»æ˜¯æ•´æ•°
```

**æ•ˆæœ:**
- âœ… `25.0` â†’ `25`
- âœ… `1.5` â†’ `1`ï¼ˆå‘ä¸‹å–æ•´ï¼‰
- âœ… å­—ç¬¦ä¸²æ­£ç¡®æ ¼å¼åŒ–ä¸º `'Under 25'`

### ä¿®å¤ 3: æ›´æ–°å‰ç«¯é€‰é¡¹

**æ–‡ä»¶:** `web/templates/scanner.html:12-17`

```html
<select id="filter-index" class="filter-input">
    <option value="sp500">S&P 500</option>
    <option value="nasdaq">NASDAQ 100</option>
    <option value="dow">Dow Jones (DJIA)</option>
    <option value="russell">Russell 2000</option>
</select>
```

**æ–‡ä»¶:** `web/templates/scanner.html:25`

```html
<input type="number" id="filter-peg" class="filter-input"
       value="1" min="1" max="3" step="1">
```

**æ•ˆæœ:**
- âœ… é€‰é¡¹æ–‡æœ¬å‡†ç¡®åæ˜ å®é™…æŒ‡æ•°èŒƒå›´
- âœ… æ·»åŠ  Russell 2000 é€‰é¡¹
- âœ… PEG è¾“å…¥é™åˆ¶ä¸ºæ•´æ•°ï¼ˆ1-3ï¼‰

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•é¡¹ | å‚æ•° | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|--------|------|---------|---------|
| S&P 500 æ‰«æ | index=sp500, PE<20, PEG<1 | è¿”å›è‚¡ç¥¨åˆ—è¡¨ | âœ… é€šè¿‡ (3åª) |
| NASDAQ 100 æ‰«æ | index=nasdaq, PE<25, PEG<1 | è¿”å›è‚¡ç¥¨åˆ—è¡¨ | âœ… é€šè¿‡ (3åª) |
| Dow Jones æ‰«æ | index=dow, PE<30, PEG<2 | è¿”å›è‚¡ç¥¨åˆ—è¡¨ | âœ… é€šè¿‡ (3åª) |
| Russell 2000 æ‰«æ | index=russell, PE<15, PEG<1 | è¿”å›è‚¡ç¥¨åˆ—è¡¨ | âœ… é€šè¿‡ (3åª) |

### æµ‹è¯•ç»“æœ

```
======================================================================
æµ‹è¯•ç»“æœ: âœ… 4/4 é€šè¿‡
======================================================================

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å¸‚åœºæ‰«æåŠŸèƒ½å·²å®Œå…¨ä¿®å¤ã€‚

ç¤ºä¾‹è¾“å‡º:
  NASDAQ 100 æ‰«æ:
    1. CHTR   $189.76  PE=5.23   Communication Services
    2. GILD   $124.91  PE=19.35  Healthcare
    3. PYPL   $56.89   PE=11.41  Technology
```

---

## å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`web/api/routes.py`** (3 å¤„ä¿®æ”¹)
   - æ·»åŠ æŒ‡æ•°æ˜ å°„è¡¨
   - ä¿®æ”¹ PE/PEG å‚æ•°ç±»å‹è½¬æ¢
   - æ›´æ–°æ³¨é‡Š

2. **`web/templates/scanner.html`** (2 å¤„ä¿®æ”¹)
   - æ›´æ–°æŒ‡æ•°é€‰é¡¹åˆ—è¡¨
   - ä¿®æ”¹ PEG è¾“å…¥çº¦æŸ

### å½±å“çš„åŠŸèƒ½

- âœ… å¸‚åœºæ‰«æ API (`/api/v1/market/scan`)
- âœ… å¸‚åœºæ‰«æ Web é¡µé¢ (`/scanner`)
- âœ… å‰ç«¯ç­›é€‰è¡¨å•

### ä¸å—å½±å“çš„åŠŸèƒ½

- âœ… å•è‚¡åˆ†æ API
- âœ… å¥åº·æ£€æŸ¥ API
- âœ… å…¶ä»– Web é¡µé¢

---

## å›å½’æµ‹è¯•

### å·²éªŒè¯åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| å¥åº·æ£€æŸ¥ | âœ… æ­£å¸¸ | 10ms å“åº” |
| é¦–é¡µè®¿é—® | âœ… æ­£å¸¸ | é¡µé¢åŠ è½½æ­£å¸¸ |
| å•è‚¡åˆ†æé¡µ | âœ… æ­£å¸¸ | UI å®Œæ•´ |
| å¸‚åœºæ‰«æé¡µ | âœ… å·²ä¿®å¤ | æ‰€æœ‰æŒ‡æ•°å¯ç”¨ |
| å…³äºé¡µ | âœ… æ­£å¸¸ | ä¿¡æ¯å®Œæ•´ |

---

## å­¦åˆ°çš„ç»éªŒ

### 1. ç¬¬ä¸‰æ–¹ API çš„æ ¼å¼è¦æ±‚

finvizfinance åº“å¯¹ç­›é€‰å™¨å‚æ•°æœ‰ä¸¥æ ¼çš„æ ¼å¼è¦æ±‚ï¼š
- æŒ‡æ•°åç§°å¿…é¡»ç²¾ç¡®åŒ¹é…ï¼ˆåŒ…æ‹¬ç©ºæ ¼å’Œæ•°å­—ï¼‰
- æ•°å€¼å‚æ•°å¿…é¡»æ˜¯æ•´æ•°å­—ç¬¦ä¸²ï¼Œä¸èƒ½æœ‰å°æ•°ç‚¹
- æ²¡æœ‰æä¾›æ¸…æ™°çš„ API æ–‡æ¡£ï¼Œéœ€è¦é€šè¿‡é”™è¯¯ä¿¡æ¯åæ¨

**æœ€ä½³å®è·µ:**
- ä¸ºç¬¬ä¸‰æ–¹ API åˆ›å»ºæ˜ å°„è¡¨
- è¿›è¡Œå‚æ•°ç±»å‹éªŒè¯å’Œè½¬æ¢
- æ•è·é”™è¯¯å¹¶æä¾›å‹å¥½æç¤º

### 2. å‰åç«¯å‚æ•°ä¸€è‡´æ€§

å‰ç«¯å…è®¸è¾“å…¥çš„å€¼èŒƒå›´åº”è¯¥ä¸åç«¯ API çš„é™åˆ¶ä¿æŒä¸€è‡´ã€‚

**æ”¹è¿›æªæ–½:**
- å‰ç«¯è¡¨å•éªŒè¯ä¸åç«¯ API çº¦æŸåŒæ­¥
- ä½¿ç”¨ç»Ÿä¸€çš„é…ç½®æ–‡ä»¶å®šä¹‰å¯ç”¨é€‰é¡¹
- æ·»åŠ å‰ç«¯é”™è¯¯æç¤º

### 3. é”™è¯¯ä¿¡æ¯çš„ä»·å€¼

finvizfinance çš„é”™è¯¯ä¿¡æ¯éå¸¸æœ‰å¸®åŠ©ï¼Œç›´æ¥åˆ—å‡ºäº†æ‰€æœ‰å¯ç”¨é€‰é¡¹ï¼š
```
Possible filter options: ['Any', 'S&P 500', 'NASDAQ 100', 'DJIA', 'RUSSELL 2000']
```

**æœ€ä½³å®è·µ:**
- åœ¨è‡ªå·±çš„ API ä¸­ä¹Ÿæä¾›ç±»ä¼¼çš„é”™è¯¯ä¿¡æ¯
- é”™è¯¯ä¿¡æ¯åº”åŒ…å«ï¼š
  - é—®é¢˜æè¿°
  - æ¥æ”¶åˆ°çš„å€¼
  - å¯æ¥å—çš„å€¼åˆ—è¡¨
  - ç¤ºä¾‹

---

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸ (1-2å¤©)

1. **æ·»åŠ å‰ç«¯éªŒè¯**
   - åœ¨å‘é€è¯·æ±‚å‰éªŒè¯å‚æ•°
   - æ˜¾ç¤ºå¯ç”¨é€‰é¡¹çš„æç¤ºæ–‡æœ¬
   - é˜²æ­¢æ— æ•ˆè¯·æ±‚

2. **æ”¹è¿›é”™è¯¯æç¤º**
   - å°† finviz é”™è¯¯è½¬æ¢ä¸ºä¸­æ–‡
   - åœ¨å‰ç«¯æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯æ¶ˆæ¯
   - æ·»åŠ "é‡è¯•"æŒ‰é’®

### ä¸­æœŸ (1å‘¨)

3. **å‚æ•°é…ç½®æ–‡ä»¶**
   ```python
   # config/scanner_options.py
   INDEX_OPTIONS = {
       'sp500': {'name': 'S&P 500', 'finviz': 'S&P 500'},
       'nasdaq': {'name': 'NASDAQ 100', 'finviz': 'NASDAQ 100'},
       # ...
   }

   PE_OPTIONS = [5, 10, 15, 20, 25, 30, 35, 40, 45, 50]
   PEG_OPTIONS = [1, 2, 3]
   ```

4. **åŠ¨æ€ç”Ÿæˆå‰ç«¯é€‰é¡¹**
   - ä»åç«¯ API è·å–å¯ç”¨ç­›é€‰é€‰é¡¹
   - å‰ç«¯è‡ªåŠ¨ç”Ÿæˆä¸‹æ‹‰åˆ—è¡¨
   - ä¿è¯å‰åç«¯ä¸€è‡´æ€§

### é•¿æœŸ (1ä¸ªæœˆ)

5. **ç¼“å­˜ç­›é€‰ç»“æœ**
   - ä½¿ç”¨ Redis ç¼“å­˜å¸¸è§æŸ¥è¯¢
   - TTL: 5 åˆ†é’Ÿ
   - å‡å°‘ finviz API è°ƒç”¨

6. **æ·»åŠ é¢„è®¾ç­›é€‰æ¨¡æ¿**
   - "é«˜å¢é•¿ä½ä¼°å€¼" (PEG<1, PE<20)
   - "å¤§ç›˜è“ç­¹" (S&P 500, PE<25)
   - "å°ç›˜æˆé•¿" (Russell 2000, PEG<1)

---

## éƒ¨ç½²æ¸…å•

- [x] ä¿®æ”¹ä»£ç 
- [x] æœ¬åœ°æµ‹è¯•é€šè¿‡
- [x] å›å½’æµ‹è¯•é€šè¿‡
- [x] æ›´æ–°æ–‡æ¡£
- [ ] ä»£ç å®¡æŸ¥
- [ ] éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
- [ ] ç”¨æˆ·éªŒæ”¶æµ‹è¯•
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

## é™„å½•

### å®Œæ•´çš„ finviz ç­›é€‰å™¨é€‰é¡¹

**æŒ‡æ•° (Index):**
- `'Any'` - ä¸é™
- `'S&P 500'` - æ ‡æ™® 500
- `'NASDAQ 100'` - çº³æ–¯è¾¾å…‹ 100
- `'DJIA'` - é“ç¼æ–¯å·¥ä¸šå¹³å‡æŒ‡æ•°
- `'RUSSELL 2000'` - ç½—ç´  2000

**PE æ¯”ç‡ (P/E):**
- `'Any'`, `'Low (<15)'`, `'Profitable (>0)'`, `'High (>50)'`
- `'Under 5'` åˆ° `'Under 50'` (5çš„å€æ•°)
- `'Over 5'` åˆ° `'Over 50'` (5çš„å€æ•°)

**PEG æ¯”ç‡ (PEG):**
- `'Any'`, `'Low (<1)'`, `'High (>2)'`
- `'Under 1'`, `'Under 2'`, `'Under 3'`
- `'Over 1'`, `'Over 2'`, `'Over 3'`

### æµ‹è¯•å‘½ä»¤

```bash
# æµ‹è¯• NASDAQ 100 æ‰«æ
curl "http://localhost:5001/api/v1/market/scan?index=nasdaq&max_pe=25&max_peg=1&limit=5"

# æµ‹è¯• S&P 500 æ‰«æ
curl "http://localhost:5001/api/v1/market/scan?index=sp500&max_pe=20&max_peg=1&limit=5"

# æµ‹è¯• Russell 2000 æ‰«æ
curl "http://localhost:5001/api/v1/market/scan?index=russell&max_pe=15&max_peg=1&limit=5"
```

---

**ä¿®å¤çŠ¶æ€:** âœ… å·²å®Œæˆ
**éªŒè¯çŠ¶æ€:** âœ… å·²é€šè¿‡
**éƒ¨ç½²çŠ¶æ€:** ğŸ”„ å¾…éƒ¨ç½²

**ä¿®å¤ç”¨æ—¶:** çº¦ 30 åˆ†é’Ÿ
**æµ‹è¯•ç”¨æ—¶:** çº¦ 15 åˆ†é’Ÿ
**æ€»è®¡ç”¨æ—¶:** çº¦ 45 åˆ†é’Ÿ
